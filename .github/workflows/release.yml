name: Release Docker Container with versions
on:
  push:
    tags:
      - 'v*.*.*'
jobs:
  build_and_push:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set_version.outputs.version }}
    steps:
      - name: üì• –ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: üîç –û—Ç—Ä–∏–º–∞–Ω–Ω—è –≤–µ—Ä—Å—ñ—ó –∑ —Ç–µ–≥–∞
        id: set_version
        run: |
          VERSION=$(git describe --tags --abbrev=0)-$(git rev-parse --short HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: üîë –õ–æ–≥—ñ–Ω —É Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
      - name: üì¶ –ü–æ–±—É–¥–æ–≤–∞ —Ç–∞ –ø—É—à Docker-–æ–±—Ä–∞–∑—É
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/xml-app:${{ steps.set_version.outputs.version }} .
          docker push ${{ secrets.DOCKER_USERNAME }}/xml-app:${{ steps.set_version.outputs.version }}
  update_chart:
    runs-on: ubuntu-latest
    needs: build_and_push
    env:
      VERSION: ${{ needs.build_and_push.outputs.version }}
    steps:
      - name: üì• –ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é (main)
        uses: actions/checkout@v4
        with:
          ref: helm
          fetch-depth: 0
      - name: üîº –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–µ—Ä—Å—ñ—ó Helm-—á–∞—Ä—Ç—É (+1)
        run: |
          CHART_VERSION=$(yq '.version' xml-app/Chart.yaml)
          NEW_VERSION=$(echo $CHART_VERSION | awk -F. -v OFS=. '{$NF += 1 ; print}')
          yq -i ".version=\"$NEW_VERSION\"" xml-app/Chart.yaml
      - name: üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–≥–∞ –æ–±—Ä–∞–∑—É –≤ `values.yaml`
        run: yq -i ".image.tag=\"${{ env.VERSION }}\"" xml-app/values.yaml
      - name: üìù –ö–æ–º—ñ—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ–≥–æ Helm-—á–∞—Ä—Ç—É –≤ helm
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add xml-app/Chart.yaml xml-app/values.yaml
          git commit -m "üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è Helm-—á–∞—Ä—Ç—É: –≤–µ—Ä—Å—ñ—è $NEW_VERSION, –æ–±—Ä–∞–∑ $VERSION"
          git push origin helm
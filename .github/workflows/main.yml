name: Deploy Docker Container

on:
  push:
    branches:
      - develop  # –ó–∞–ø—É—Å–∫–∞—Ç–∏ –¥–µ–ø–ª–æ–π –ø—Ä–∏ –ø—É—à—ñ –≤ main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
      uses: actions/checkout@v3

    - name: üîë –õ–æ–≥—ñ–Ω —É Docker Hub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin || exit 1


    - name: üõ† –°—Ç–≤–æ—Ä–µ–Ω–Ω—è `.env` –∑ GitHub Secrets
      run: |
        echo 'GOOGLE_CREDENTIALS=${{ secrets.GOOGLE_CREDENTIALS }}' > .env
        echo 'TOKEN_JSON=${{ secrets.TOKEN_JSON }}' >> .env

    - name: üì¶ –ü–æ–±—É–¥–æ–≤–∞ Docker-–æ–±—Ä–∞–∑—É
      run: docker build -t ${{ secrets.DOCKER_USERNAME }}/xml-app:latest .

    - name: üöÄ –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è Docker-–æ–±—Ä–∞–∑—É –≤ Docker Hub
      run: docker push ${{ secrets.DOCKER_USERNAME }}/xml-app:latest

    - name: üõ† –í–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—è–∫—â–æ —ñ—Å–Ω—É—î)
      run: |
        docker stop xml_container || true
        docker rm xml_container || true

    - name: üöÄ –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      run: |
        docker run -d --name xml_container \
          --env-file .env \
          -p 8000:8000 \
          ${{ secrets.DOCKER_USERNAME }}/xml-app:latest
